depends_on:
  - build_ocis_binary_for_testing
platform:
  arch: amd64
  os: linux
steps:
  - image: owncloudci/drone-skip-pipeline
    name: skip-if-unchanged
    settings:
      ALLOW_SKIP_CHANGED:
        - ^.github/.*
        - ^.vscode/.*
        - ^changelog/.*
        - ^docs/.*
        - ^deployments/.*
        - CHANGELOG.md
        - CONTRIBUTING.md
        - LICENSE
        - README.md
        - .*_test.go$
    when:
      event:
        - pull_request
  - image: plugins/s3-cache:1
    name: restore_ocis-binary-amd64_build_artifact_cache
    settings:
      access_key:
        from_secret: cache_s3_access_key
      endpoint: https://cache.owncloud.com
      fallback_path: cache/opencloud-eu/opencloud/-${DRONE_BUILD_NUMBER}
      filename: ocis-binary-amd64_build_artifact_cache.tar
      mount:
        - ocis/bin
      path: cache/opencloud-eu/opencloud/-${DRONE_BUILD_NUMBER}
      rebuild: "false"
      restore: "true"
      secret_key:
        from_secret: cache_s3_secret_key
  - commands:
      - sh /drone/src/tests/config/drone/serve-hosting-discovery.sh
    detach: true
    environment: {}
    image: owncloudci/alpine:latest
    name: fakeoffice
  - commands:
      - wait-for -it fakeoffice:8080 -t 300
    image: owncloudci/wait-for:latest
    name: wait-for-fake-office
  - commands:
      - mkdir -p $GOCOVERDIR
      - ocis/bin/ocis-debug init --insecure true
      - cat $OCIS_CONFIG_DIR/ocis.yaml
      - cp tests/config/drone/app-registry.yaml /root/.ocis/config/app-registry.yaml
      - ocis/bin/ocis-debug server
    depends_on: []
    detach: true
    environment:
      ACTIVITYLOG_DEBUG_ADDR: 0.0.0.0:9197
      APP_PROVIDER_DEBUG_ADDR: 0.0.0.0:9165
      APP_PROVIDER_DRIVER: wopi
      APP_PROVIDER_EXTERNAL_ADDR: com.owncloud.api.app-provider
      APP_PROVIDER_WOPI_APP_NAME: FakeOffice
      APP_PROVIDER_WOPI_APP_URL: http://fakeoffice:8080
      APP_PROVIDER_WOPI_FOLDER_URL_BASE_URL: https://ocis-server:9200
      APP_PROVIDER_WOPI_INSECURE: "true"
      APP_PROVIDER_WOPI_WOPI_SERVER_EXTERNAL_URL: http://wopi-fakeoffice:9300
      APP_REGISTRY_DEBUG_ADDR: 0.0.0.0:9243
      AUTH_BASIC_DEBUG_ADDR: 0.0.0.0:9147
      AUTH_MACHINE_DEBUG_ADDR: 0.0.0.0:9167
      AUTH_SERVICE_DEBUG_ADDR: 0.0.0.0:9198
      CLIENTLOG_DEBUG_ADDR: 0.0.0.0:9260
      EVENTHISTORY_DEBUG_ADDR: 0.0.0.0:9270
      EVENTHISTORY_STORE: memory
      FRONTEND_DEBUG_ADDR: 0.0.0.0:9141
      FRONTEND_SEARCH_MIN_LENGTH: "2"
      GATEWAY_DEBUG_ADDR: 0.0.0.0:9143
      GATEWAY_GRPC_ADDR: 0.0.0.0:9142
      GOCOVERDIR: reports
      GRAPH_DEBUG_ADDR: 0.0.0.0:9124
      GROUPS_DEBUG_ADDR: 0.0.0.0:9161
      IDM_ADMIN_PASSWORD: admin
      IDM_CREATE_DEMO_USERS: true
      IDM_DEBUG_ADDR: 0.0.0.0:9239
      IDP_DEBUG_ADDR: 0.0.0.0:9134
      INVITATIONS_DEBUG_ADDR: 0.0.0.0:9269
      NATS_DEBUG_ADDR: 0.0.0.0:9234
      NATS_NATS_HOST: 0.0.0.0
      NATS_NATS_PORT: 9233
      OCDAV_DEBUG_ADDR: 0.0.0.0:9163
      OCIS_ASYNC_UPLOADS: true
      OCIS_CONFIG_DIR: /root/.ocis/config
      OCIS_EVENTS_ENABLE_TLS: false
      OCIS_EXCLUDE_RUN_SERVICES: app-provider
      OCIS_JWT_SECRET: some-ocis-jwt-secret
      OCIS_LOG_LEVEL: error
      OCIS_TRANSLATION_PATH: /drone/src/tests/config/translations
      OCIS_URL: https://ocis-server:9200
      OCM_DEBUG_ADDR: 0.0.0.0:9281
      OCS_DEBUG_ADDR: 0.0.0.0:9114
      POSTPROCESSING_DEBUG_ADDR: 0.0.0.0:9255
      PROXY_DEBUG_ADDR: 0.0.0.0:9205
      PROXY_ENABLE_BASIC_AUTH: true
      SEARCH_DEBUG_ADDR: 0.0.0.0:9224
      SETTINGS_DEBUG_ADDR: 0.0.0.0:9194
      SHARING_DEBUG_ADDR: 0.0.0.0:9151
      SSE_DEBUG_ADDR: 0.0.0.0:9139
      STORAGE_PUBLICLINK_DEBUG_ADDR: 0.0.0.0:9179
      STORAGE_SHARES_DEBUG_ADDR: 0.0.0.0:9156
      STORAGE_SYSTEM_DEBUG_ADDR: 0.0.0.0:9217
      STORAGE_USERS_DEBUG_ADDR: 0.0.0.0:9159
      STORAGE_USERS_DRIVER: ocis
      THUMBNAILS_DEBUG_ADDR: 0.0.0.0:9189
      USERLOG_DEBUG_ADDR: 0.0.0.0:9214
      USERS_DEBUG_ADDR: 0.0.0.0:9145
      WEB_DEBUG_ADDR: 0.0.0.0:9104
      WEB_UI_CONFIG_FILE: /drone/src/tests/config/drone/ocis-config.json
      WEBDAV_DEBUG_ADDR: 0.0.0.0:9119
      WEBFINGER_DEBUG_ADDR: 0.0.0.0:9279
    image: owncloudci/golang:1.24
    name: ocis-server
    user: "0:0"
    volumes: []
  - commands:
      - timeout 300 bash -c 'while [ $(curl -sk -uadmin:admin https://ocis-server:9200/graph/v1.0/users/admin -w %{http_code} -o /dev/null) != 200 ]; do sleep 1; done'
    depends_on: []
    image: owncloudci/alpine:latest
    name: wait-for-ocis-server
  - commands:
      - ocis/bin/ocis-debug collaboration server
    detach: true
    environment:
      COLLABORATION_APP_ADDR: http://fakeoffice:8080
      COLLABORATION_APP_INSECURE: "true"
      COLLABORATION_APP_NAME: FakeOffice
      COLLABORATION_APP_PRODUCT: Microsoft
      COLLABORATION_APP_PROOF_DISABLE: "true"
      COLLABORATION_CS3API_DATAGATEWAY_INSECURE: "true"
      COLLABORATION_DEBUG_ADDR: 0.0.0.0:9304
      COLLABORATION_GRPC_ADDR: 0.0.0.0:9301
      COLLABORATION_HTTP_ADDR: 0.0.0.0:9300
      COLLABORATION_LOG_LEVEL: debug
      COLLABORATION_WOPI_SECRET: some-wopi-secret
      COLLABORATION_WOPI_SRC: http://wopi-fakeoffice:9300
      MICRO_REGISTRY: nats-js-kv
      MICRO_REGISTRY_ADDRESS: ocis-server:9233
      OCIS_JWT_SECRET: some-ocis-jwt-secret
    image: owncloudci/golang:1.24
    name: wopi-fakeoffice
    volumes: []
  - commands:
      - wait-for -it wopi-fakeoffice:9300 -t 300
    image: owncloudci/wait-for:latest
    name: wait-for-wopi-fakeoffice
  - commands:
      - curl -v -X PUT 'https://ocis-server:9200/remote.php/webdav/test.wopitest' -k --fail --retry-connrefused --retry 7 --retry-all-errors -u admin:admin -D headers.txt
      - cat headers.txt
      - 'export FILE_ID=$(cat headers.txt | sed -n -e ''s/^.*Oc-Fileid: //p'')'
      - export URL="https://ocis-server:9200/app/open?app_name=FakeOffice&file_id=$FILE_ID"
      - export URL=$(echo $URL | tr -d '[:cntrl:]')
      - curl -v -X POST "$URL" -k --fail --retry-connrefused --retry 7 --retry-all-errors -u admin:admin > open.json
      - cat open.json
      - cat open.json | jq .form_parameters.access_token | tr -d '"' > accesstoken
      - cat open.json | jq .form_parameters.access_token_ttl | tr -d '"' > accesstokenttl
      - echo -n 'http://wopi-fakeoffice:9300/wopi/files/' > wopisrc
      - cat open.json | jq .app_url | sed -n -e 's/^.*files%2F//p' | tr -d '"' >> wopisrc
    environment: {}
    image: owncloudci/alpine:latest
    name: prepare-test-file
  - commands:
      - export WOPI_TOKEN=$(cat accesstoken)
      - echo $WOPI_TOKEN
      - export WOPI_TTL=$(cat accesstokenttl)
      - echo $WOPI_TTL
      - export WOPI_SRC=$(cat wopisrc)
      - echo $WOPI_SRC
      - cd /app
      - /app/Microsoft.Office.WopiValidator -t $WOPI_TOKEN -w $WOPI_SRC -l $WOPI_TTL --testgroup BaseWopiViewing
    image: owncloudci/wopi-validator
    name: wopiValidatorTests-BaseWopiViewing
  - commands:
      - export WOPI_TOKEN=$(cat accesstoken)
      - echo $WOPI_TOKEN
      - export WOPI_TTL=$(cat accesstokenttl)
      - echo $WOPI_TTL
      - export WOPI_SRC=$(cat wopisrc)
      - echo $WOPI_SRC
      - cd /app
      - /app/Microsoft.Office.WopiValidator -t $WOPI_TOKEN -w $WOPI_SRC -l $WOPI_TTL --testgroup CheckFileInfoSchema
    image: owncloudci/wopi-validator
    name: wopiValidatorTests-CheckFileInfoSchema
  - commands:
      - export WOPI_TOKEN=$(cat accesstoken)
      - echo $WOPI_TOKEN
      - export WOPI_TTL=$(cat accesstokenttl)
      - echo $WOPI_TTL
      - export WOPI_SRC=$(cat wopisrc)
      - echo $WOPI_SRC
      - cd /app
      - /app/Microsoft.Office.WopiValidator -t $WOPI_TOKEN -w $WOPI_SRC -l $WOPI_TTL --testgroup EditFlows
    image: owncloudci/wopi-validator
    name: wopiValidatorTests-EditFlows
  - commands:
      - export WOPI_TOKEN=$(cat accesstoken)
      - echo $WOPI_TOKEN
      - export WOPI_TTL=$(cat accesstokenttl)
      - echo $WOPI_TTL
      - export WOPI_SRC=$(cat wopisrc)
      - echo $WOPI_SRC
      - cd /app
      - /app/Microsoft.Office.WopiValidator -t $WOPI_TOKEN -w $WOPI_SRC -l $WOPI_TTL --testgroup Locks
    image: owncloudci/wopi-validator
    name: wopiValidatorTests-Locks
  - commands:
      - export WOPI_TOKEN=$(cat accesstoken)
      - echo $WOPI_TOKEN
      - export WOPI_TTL=$(cat accesstokenttl)
      - echo $WOPI_TTL
      - export WOPI_SRC=$(cat wopisrc)
      - echo $WOPI_SRC
      - cd /app
      - /app/Microsoft.Office.WopiValidator -t $WOPI_TOKEN -w $WOPI_SRC -l $WOPI_TTL --testgroup AccessTokens
    image: owncloudci/wopi-validator
    name: wopiValidatorTests-AccessTokens
  - commands:
      - export WOPI_TOKEN=$(cat accesstoken)
      - echo $WOPI_TOKEN
      - export WOPI_TTL=$(cat accesstokenttl)
      - echo $WOPI_TTL
      - export WOPI_SRC=$(cat wopisrc)
      - echo $WOPI_SRC
      - cd /app
      - /app/Microsoft.Office.WopiValidator -t $WOPI_TOKEN -w $WOPI_SRC -l $WOPI_TTL --testgroup GetLock
    image: owncloudci/wopi-validator
    name: wopiValidatorTests-GetLock
  - commands:
      - export WOPI_TOKEN=$(cat accesstoken)
      - echo $WOPI_TOKEN
      - export WOPI_TTL=$(cat accesstokenttl)
      - echo $WOPI_TTL
      - export WOPI_SRC=$(cat wopisrc)
      - echo $WOPI_SRC
      - cd /app
      - /app/Microsoft.Office.WopiValidator -t $WOPI_TOKEN -w $WOPI_SRC -l $WOPI_TTL --testgroup ExtendedLockLength
    image: owncloudci/wopi-validator
    name: wopiValidatorTests-ExtendedLockLength
  - commands:
      - export WOPI_TOKEN=$(cat accesstoken)
      - echo $WOPI_TOKEN
      - export WOPI_TTL=$(cat accesstokenttl)
      - echo $WOPI_TTL
      - export WOPI_SRC=$(cat wopisrc)
      - echo $WOPI_SRC
      - cd /app
      - /app/Microsoft.Office.WopiValidator -t $WOPI_TOKEN -w $WOPI_SRC -l $WOPI_TTL --testgroup FileVersion
    image: owncloudci/wopi-validator
    name: wopiValidatorTests-FileVersion
  - commands:
      - export WOPI_TOKEN=$(cat accesstoken)
      - echo $WOPI_TOKEN
      - export WOPI_TTL=$(cat accesstokenttl)
      - echo $WOPI_TTL
      - export WOPI_SRC=$(cat wopisrc)
      - echo $WOPI_SRC
      - cd /app
      - /app/Microsoft.Office.WopiValidator -t $WOPI_TOKEN -w $WOPI_SRC -l $WOPI_TTL --testgroup Features
    image: owncloudci/wopi-validator
    name: wopiValidatorTests-Features
  - commands:
      - export WOPI_TOKEN=$(cat accesstoken)
      - echo $WOPI_TOKEN
      - export WOPI_TTL=$(cat accesstokenttl)
      - echo $WOPI_TTL
      - export WOPI_SRC=$(cat wopisrc)
      - echo $WOPI_SRC
      - cd /app
      - /app/Microsoft.Office.WopiValidator -s -t $WOPI_TOKEN -w $WOPI_SRC -l $WOPI_TTL --testgroup PutRelativeFile
    image: owncloudci/wopi-validator
    name: wopiValidatorTests-PutRelativeFile
  - commands:
      - export WOPI_TOKEN=$(cat accesstoken)
      - echo $WOPI_TOKEN
      - export WOPI_TTL=$(cat accesstokenttl)
      - echo $WOPI_TTL
      - export WOPI_SRC=$(cat wopisrc)
      - echo $WOPI_SRC
      - cd /app
      - /app/Microsoft.Office.WopiValidator -s -t $WOPI_TOKEN -w $WOPI_SRC -l $WOPI_TTL --testgroup RenameFileIfCreateChildFileIsNotSupported
    image: owncloudci/wopi-validator
    name: wopiValidatorTests-RenameFileIfCreateChildFileIsNotSupported
trigger:
  ref:
    - refs/heads/master
    - refs/heads/stable-*
    - refs/pull/**
